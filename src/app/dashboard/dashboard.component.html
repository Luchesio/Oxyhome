<app-sidebar></app-sidebar>

<div class="dashboard">
  <header class="dashboard-header">
    <h1 class="page-title">Dashboard</h1>
    <div class="header-actions">
      <button
        class="notification-btn"
        [class.has-notification]="hasNotifications"
        (click)="goToNotifications()"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
        >
          <path
            d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"
          />
        </svg>
      </button>
      <div class="user-profile" (click)="goToProfile()">
        <img
          [src]="userProfile.avatar"
          [alt]="userProfile.name"
          class="avatar"
        />
        <span class="user-name">{{ userProfile.name }}</span>
        <button class="dropdown-toggle">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path d="M7 10l5 5 5-5z" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <div class="dashboard-content">
    <div class="cards-row">
      <!-- Wallet Balance Card -->
      <div class="card wallet-card">
        <div class="card-header">
          <h2 class="card-title">Wallet Balance</h2>
          <button class="icon-btn">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"
              />
            </svg>
          </button>
        </div>
        <div class="balance-amount">
          <span class="currency">₦</span>
          <span class="amount">{{ walletBalance | number: "1.2-2" }}</span>
          <button class="trend-btn positive">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"
              />
            </svg>
          </button>
        </div>
        <p class="card-subtitle">Available Credit</p>
      </div>

      <!-- Linked Bank Account Card -->
      <div class="card bank-card">
        <div class="card-header">
          <h2 class="card-title">Linked Bank Account</h2>
        </div>
        <div class="bank-info">
          <div class="bank-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M4 10h3v7H4zm6.5 0h3v7h-3zM2 19h20v3H2zm15-9h3v7h-3zm-5-9L2 6v2h20V6z"
              />
            </svg>
          </div>
          <div class="bank-details">
            <p class="account-name">{{ bankAccount.name }}</p>
            <p class="bank-name" *ngIf="bankAccount.bankName">
              {{ bankAccount.bankName }}
            </p>
            <p class="account-number">
              {{ bankAccount.fullAccountNumber || "••••" }}
            </p>
          </div>
        </div>
        <button class="btn-primary" (click)="openLinkBankModal()">
          {{ hasLinkedAccount ? "Change Bank Account" : "Link Bank Account" }}
        </button>
      </div>
    </div>

    <!-- Active Mandates Section -->
    <div class="mandates-section">
      <div class="section-header">
        <h2 class="section-title">Active Mandates</h2>
        <button class="btn-view-all" (click)="goToMandates()">
          View All
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
          </svg>
        </button>
      </div>

      <div class="mandates-content">
        <!-- Loading State -->
        <div class="loading-container" *ngIf="isLoadingMandates">
          <div class="loading-spinner">
            <svg class="spinner" viewBox="0 0 24 24">
              <circle
                class="spinner-circle"
                cx="12"
                cy="12"
                r="10"
                stroke-width="3"
                fill="none"
              />
            </svg>
            <p class="loading-text">Loading mandates...</p>
          </div>
        </div>

        <!-- Error State -->
        <div
          class="error-container"
          *ngIf="!isLoadingMandates && mandatesError"
        >
          <div class="error-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
              />
            </svg>
          </div>
          <p class="error-message">{{ mandatesError }}</p>
          <button class="btn-retry" (click)="refreshMandates()">
            Try Again
          </button>
        </div>

        <!-- Empty State -->
        <div
          class="empty-container"
          *ngIf="
            !isLoadingMandates &&
            !mandatesError &&
            displayedMandates.length === 0
          "
        >
          <div class="empty-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"
              />
            </svg>
          </div>
          <p class="empty-message">No active mandates</p>
          <p class="empty-subtitle">
            You don't have any active payment mandates at the moment
          </p>
        </div>

        <!-- Mandates Grid (Limited to 2) -->
        <div
          class="mandates-grid"
          *ngIf="
            !isLoadingMandates && !mandatesError && displayedMandates.length > 0
          "
        >
          <div class="mandate-card" *ngFor="let account of displayedMandates">
            <div class="mandate-header">
              <div class="bank-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M4 10v7h3v-7H4zm6 0v7h3v-7h-3zM2 22h19v-3H2v3zm14-12v7h3v-7h-3zm-4.5-9L2 6v2h19V6l-9.5-5z"
                  />
                </svg>
              </div>
              <div
                class="status-badge"
                [ngClass]="getStatusClass(account.extended_data.mandate_status)"
              >
                {{ account.extended_data.mandate_status }}
              </div>
            </div>

            <div class="mandate-body">
              <div class="info-group">
                <span class="info-label">Account Name</span>
                <span class="info-value">{{ account.account_name }}</span>
              </div>

              <div class="info-group">
                <span class="info-label">Account Number</span>
                <span class="info-value highlight">{{
                  account.account_number
                }}</span>
              </div>

              <div class="info-group">
                <span class="info-label">Bank Name</span>
                <span class="info-value">{{ account.bank_name }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Show count if more mandates exist -->
        <div class="more-mandates" *ngIf="remainingMandatesCount > 0">
          <p class="more-text">
            + {{ remainingMandatesCount }} more mandate{{
              remainingMandatesCount > 1 ? "s" : ""
            }}
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Link Bank Account Modal -->
<div
  class="modal-overlay"
  *ngIf="showLinkBankModal"
  (click)="closeLinkBankModal()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Link Bank Account</h2>
      <button class="modal-close" (click)="closeLinkBankModal()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
        >
          <path
            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
          />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <form class="link-bank-form">
        <div class="form-group">
          <label for="bankSelect" class="form-label">Select Bank</label>
          <select
            id="bankSelect"
            [(ngModel)]="selectedBankCode"
            name="bankCode"
            class="form-control"
            required
          >
            <option value="" disabled selected>Choose your bank</option>
            <option *ngFor="let bank of banks" [value]="bank.code">
              {{ bank.name }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="linkAccountNumber" class="form-label"
            >Account Number</label
          >
          <input
            type="text"
            id="linkAccountNumber"
            [(ngModel)]="linkAccountNumber"
            name="linkAccountNumber"
            class="form-control"
            placeholder="Enter your 10-digit account number"
            maxlength="10"
            pattern="[0-9]{10}"
            required
          />
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button
        class="btn-secondary"
        (click)="closeLinkBankModal()"
        [disabled]="isLinkingBank"
      >
        Cancel
      </button>
      <button
        class="btn-primary"
        (click)="submitBankAccountLookup()"
        [disabled]="!isLinkBankFormValid() || isLinkingBank"
      >
        <span *ngIf="!isLinkingBank">Verify Account</span>
        <span *ngIf="isLinkingBank" class="loading-spinner">
          <svg class="spinner" viewBox="0 0 24 24">
            <circle
              class="spinner-circle"
              cx="12"
              cy="12"
              r="10"
              stroke-width="3"
              fill="none"
            />
          </svg>
          Verifying...
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Bank Account Response Modal -->
<div
  class="modal-overlay"
  *ngIf="showBankResponseModal"
  (click)="closeBankResponseModal()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Account Verification</h2>
      <button class="modal-close" (click)="closeBankResponseModal()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
        >
          <path
            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
          />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <!-- <div class="message-section">
        <div class="message-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
          </svg>
        </div>
        <p class="message-text">{{ bankResponseMessage }}</p>
      </div> -->

      <div class="account-details-section" *ngIf="bankResponseData">
        <h3 class="section-title">Account Details</h3>
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">Account Name</span>
            <span class="detail-value">{{
              bankResponseData.account_name
            }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">Account Number</span>
            <span class="detail-value highlight">{{
              bankResponseData.account_number
            }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">Customer ID</span>
            <span class="detail-value">{{ bankResponseData.customer_id }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">First Name</span>
            <span class="detail-value">{{ bankResponseData.first_name }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">Last Name</span>
            <span class="detail-value">{{ bankResponseData.last_name }}</span>
          </div>

          <div
            class="detail-item"
            *ngIf="
              bankResponseData.middle_name &&
              bankResponseData.middle_name !== '-'
            "
          >
            <span class="detail-label">Middle Name</span>
            <span class="detail-value">{{ bankResponseData.middle_name }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">Gender</span>
            <span class="detail-value">{{ bankResponseData.gender }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">Currency</span>
            <span class="detail-value">{{
              bankResponseData.account_currency
            }}</span>
          </div>

          <div class="detail-item full-width" *ngIf="bankResponseData.dob">
            <span class="detail-label">Date of Birth</span>
            <span class="detail-value">{{ bankResponseData.dob }}</span>
          </div>

          <div class="detail-item full-width">
            <span class="detail-label">Reference</span>
            <span class="detail-value">{{ bankResponseData.reference }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-primary" (click)="saveBankAccountToDatabase()">
        Done & Link Account
      </button>
    </div>
  </div>
</div>

<!-- Link Account Notification -->
<div class="link-account-notification" *ngIf="showLinkAccountNotification">
  <div class="notification-content">
    <div class="notification-icon">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
      >
        <path
          d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
        />
      </svg>
    </div>
    <div class="notification-body">
      <h4 class="notification-title">Link Your Bank Account</h4>
      <p class="notification-message">
        Please link your bank account to enable payments and installment
        features.
      </p>
    </div>
    <button
      class="notification-action"
      (click)="openLinkBankModal(); dismissLinkAccountNotification()"
    >
      Link Now
    </button>
    <button
      class="notification-close"
      (click)="dismissLinkAccountNotification()"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
      >
        <path
          d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
        />
      </svg>
    </button>
  </div>
</div>
